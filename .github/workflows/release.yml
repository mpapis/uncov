name: Release

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Action Release"
          git config user.email "actions@github.com"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install gem-release
        run: gem install gem-release

      - name: Determine current version
        id: current_version
        run: |
          CURRENT_VERSION=$(ruby -e "require './lib/uncov/version'; puts Uncov::VERSION")
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v3
        with:
          configurationJson: |
            {
              "categories": [
                { "title": "## Major", "labels": ["breaking"] }
                { "title": "## Minor", "labels": ["feature"] },
                { "title": "## Patch", "labels": ["fix"] }
              ],
              "ignore_labels": ["ignore"]
            }
          fromTag: "v${{ steps.current_version.outputs.current_version }}"
          toTag: "HEAD"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect version bump
        uses: actions-ecosystem/action-regex-match@v2
        id: version_bump_match
        with:
          text: ${{ steps.changelog.outputs.changelog }}
          regex: '^## (Major|Minor|Patch)$'
          flags: m

      - name: No changes failure
        if: ${{ steps.version_bump_match.outputs.match == '' }}
        run: exit 1

      - name: Lowercase version bump
        id: version_bump
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ steps.version_bump_match.outputs.group1 }}

      - name: Bump version
        id: bump_version
        run: |
          gem bump --no-commit --version ${{ steps.version_bump.outputs.lowercase }}
          # Get the new version after bumping
          NEW_VERSION=$(ruby -e "require './lib/uncov/version'; puts Uncov::VERSION")
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Gemfile.lock gem version
        run: |
          bundle config set frozen false
          bundle install

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.bump_version.outputs.new_version }}"
          DATE=$(date +"%Y-%m-%d")
          CHANGELOG_ENTRY="## [$VERSION] - $DATE\n\n${{ steps.changelog.outputs.changelog }}\n"
          echo -e "# Changelog\n\n$CHANGELOG_ENTRY" > CHANGELOG_NEW.md
          [ -f CHANGELOG.md ] && tail -n +2 CHANGELOG.md >> CHANGELOG_NEW.md
          mv CHANGELOG_NEW.md CHANGELOG.md

      - name: Git push changes
        run: |
          git add Gemfile.lock CHANGELOG.md lib/uncov/version.rb
          git commit -m "Prepare release v${{ steps.bump_version.outputs.new_version }}"
          git push

      - name: Configure trusted publishing credentials
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Release
        run: |
          gem release --tag --push --github -d "${{ steps.changelog.outputs.changelog }}"
